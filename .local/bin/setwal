#!/bin/sh
PROG_NAME="$(basename "$0")"

# ======================= VARIABLES ====================== #
CACHE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/wallpaper"

# Error codes
FILE_DOES_NOT_EXIST=1
INVALID_MIME_TYPE=2
COULD_NOT_LOAD_CACHE=3
# ======================================================== #


# ====================== FUNCTIONS ====================== #
_eputs() {
	echo "$PROG_NAME: $@" >&2
}

_str_str() {
	# HAYSTACK="$1"
	# NEEDLE="$2"
	echo "$1" | grep -Fiq "$2"
}

_is_animated() {
	# MIME_TYPE="$1"
	_str_str "$1" "video" ||
		_str_str "$1" "gif"
}

_is_image() {
	# MIME_TYPE="$1"
	_str_str "$1" "image"
}

_clear_bg() {
	animwal --stop
}
# ======================================================= #

if [ "$#" = 0 ]; then
	if [ -x "$CACHE_FILE" ]; then
		_clear_bg
		$CACHE_FILE
		exit
	else
		_eputs "Could not load '$CACHE_FILE'"
		exit $COULD_NOT_LOAD_CACHE
	fi
elif [ ! -f "$1" ]; then
	_eputs "File \"$1\" does not exist"
	exit $FILE_DOES_NOT_EXIST
fi

WALL="$(readlink -f "$1")"
MIME="$(file --mime-type -Lb "$1")"

# DEBUG echo "Wall: $WALL"
# DEBUG echo "Mime: $MIME"

if _is_animated "$MIME"; then
	SETWALL="animwal"
elif _is_image "$MIME"; then
	_clear_bg
	SETWALL="feh --no-fehbg --bg-fill"
else
	_eputs "Invalid mime type"
	exit $INVALID_MIME_TYPE
fi

# DEBUG echo "$SETWALL \"$WALL\""

if $SETWALL "$WALL"; then
  cat <<EOF >| "$CACHE_FILE"
#! /bin/sh
$SETWALL "$WALL"
EOF
	chmod +x "$CACHE_FILE"
fi
