#!/bin/sh
#
# Write/remove a task to do later.
#
# Select an existing entry to remove it from the file, or type a new entry to
# add it.
#

FILE="${TODO_FILE-:${XDG_DATA_HOME:-$HOME/.local/share}/todo.md}"
[ -f "$FILE" ] || touch "$FILE"
HEIGHT=$(wc -l "$FILE" | awk '{print $1}')
PROMPT="Add/delete a task: "

CMD=$(dmenu_custom -l "$HEIGHT" -p "$PROMPT" "$@" < "$FILE")

while [ -n "$CMD" ]; do
    if grep -q "^$CMD\$" "$FILE"; then
        grep -v "^$CMD\$" "$FILE" > "$FILE.$$"
        mv "$FILE.$$" "$FILE"
        HEIGHT=$(( HEIGHT - 1 ))
    else
        echo "$CMD" >> "$FILE"
        HEIGHT=$(( HEIGHT + 1 ))
    fi

    CMD=$(dmenu_custom -l "$HEIGHT" -p "$PROMPT" "$@" < "$FILE")
done
